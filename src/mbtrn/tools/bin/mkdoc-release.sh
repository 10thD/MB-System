#!/bin/bash

#########################################
# Name: mkdoc-release.sh
#
# Summary: make documentation bundle
#
# Description: Build HTML and PDF doc from markdown
#
#  ./mkdoc/mkdoc-release.sh
#
# Author: kheadley
#
# Copyright 2020 MBARI
#
#########################################

PKG_NAME="mbtrn"
# set session ID and other common environment used by all doc
export MKDOC_SESSION=${PKG_REL_DATE:-$(date +%y%m%d-%H%M%S)}
MKDOC_HOME_DFL=$(cd "$(dirname ${0})" && pwd)
MKDOC_HOME=${MKDOC_HOME:-${MKDOC_HOME_DFL}}
SRC_DIR=$(cd "$(dirname ${MKDOC_HOME})" && $(cd "..") && pwd)
PKG_NAME=${PKG_NAME:-"pkg"}
PANDOC=$(which pandoc)
HTMLTOPDF=$(which wkhtmltopdf)
GS=$(which gs)
export MKDOC_OPATH=${PKG_REL_DOC:-"${PKG_NAME}-doc-${MKDOC_SESSION}"}
env|grep MKDOC
env|grep PKG_
# generate doc sets
${MKDOC_HOME}/mkdoc.sh -vi ${SRC_DIR}/README-test.md
${MKDOC_HOME}/mkdoc.sh -vi ${SRC_DIR}/README-tools.md
${MKDOC_HOME}/mkdoc.sh -vi ${SRC_DIR}/mbtrnpp-plot/README-mbtrn-plot-dev.md
${MKDOC_HOME}/mkdoc.sh -vi ${SRC_DIR}/mbtrnpp-plot/README-mbtrn-plot-use.md
${MKDOC_HOME}/mkdoc.sh -vi ${SRC_DIR}/mbtrncfg/README-mbtrncfg.md
${MKDOC_HOME}/mkdoc.sh -vi ${SRC_DIR}/cfg/README-mbtrnpp.md
${MKDOC_HOME}/mkdoc.sh -vi ${SRC_DIR}/bin/README-bin.md

if [ -d "${MKDOC_OPATH}" ]
then

# generate README markdown source
cat << END_README > ${MKDOC_OPATH}/README.md
## mptrnpp documentation README
### Package Contents
#### auto-generated by $(basename $0) $(date +%y-%m-%dT%H:%M:%S)

|Package Files         |                         |
|----------------------|-------------------------|
|__README files__      |                         |
|README-test           |TRN testing              |
|README-tools          |tools directory contents |
|README-mbtrn-plot-dev |TRN plot developers guide|
|README-mbtrn-plot-use |TRN plot users guide     |
|README-mbtrncfg       |mbtrnpp web config tool  |
|README-mbtrnpp        |mbtrnpp use notes        |
|README-bin            |mbtrn util scripts       |


|Directories     |                                |
|----------------|--------------------------------|
|styles          |CSS styles                      |

END_README

# generate README PDF (md > html > pdf)
cp ${MKDOC_HOME}/styles/radar.css ${MKDOC_OPATH}/styles/.
cd ${MKDOC_OPATH}
${PANDOC} -s -c styles/radar.css  README.md --metadata title="Documentation README" -o README.html
${HTMLTOPDF} -s Letter --margin-bottom 25mm --margin-top 25mm --margin-left 20mm --margin-right 20mm --enable-local-file-access README.html README.pdf
rm README.html

fi

